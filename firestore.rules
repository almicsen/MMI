rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to safely get user role (handles missing documents)
    function getUserRole() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid)) 
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role 
        : null;
    }
    
    // Helper function to check if user is admin (safe version)
    // Note: This reads the user document, so it should be used carefully in rules
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }
    
    // Helper function to check if user is admin (for collection queries)
    // This version allows reading the user's own document to check role
    function isAdminForList() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Helper function to check if user is employee or admin (safe version)
    function isEmployeeOrAdmin() {
      return isAuthenticated() && (getUserRole() == 'employee' || getUserRole() == 'admin');
    }
    
    // Users collection
    match /users/{userId} {
      // For collection queries (list), allow if admin
      // For individual document reads (get), allow if own document or admin
      allow list: if isAuthenticated() && isAdminForList();
      allow get: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      // Users can create their own document on first login
      allow create: if isAuthenticated() && request.auth.uid == userId;
      // Users can update their own document (but cannot change role), admins can update any user
      allow update: if isAuthenticated() && 
                     ((request.auth.uid == userId && 
                       (!('role' in request.resource.data) || 
                        request.resource.data.role == resource.data.role)) ||
                      isAdmin());
      // Only admins can delete user documents
      allow delete: if isAdmin();
    }
    
    // Projects collection
    match /projects/{projectId} {
      // Everyone can read projects
      allow read: if true;
      // Only admins can write
      allow write: if isAdmin();
    }
    
    // Collaborations collection
    match /collaborations/{collaborationId} {
      // Everyone can read collaborations
      allow read: if true;
      // Only admins can write
      allow write: if isAdmin();
    }
    
    // Content collection (series, movies, podcasts)
    match /content/{contentId} {
      // Everyone can read published content, admins can read all
      allow read: if !exists(/databases/$(database)/documents/content/$(contentId)) || 
                     resource.data.published == true || 
                     isAdmin();
      // Only admins can write
      allow write: if isAdmin();
    }
    
    // Series collection
    match /series/{seriesId} {
      // Everyone can read published series, admins can read all
      allow read: if !exists(/databases/$(database)/documents/series/$(seriesId)) || 
                     resource.data.published == true || 
                     isAdmin();
      // Only admins can write
      allow write: if isAdmin();
    }
    
    // Blog posts collection
    match /blogPosts/{postId} {
      // Everyone can read published posts, admins can read all
      allow read: if !exists(/databases/$(database)/documents/blogPosts/$(postId)) || 
                     resource.data.published == true || 
                     isAdmin();
      // Only admins can write
      allow write: if isAdmin();
    }
    
    // Pages collection (About, Services, etc.)
    match /pages/{pageId} {
      // Everyone can read
      allow read: if true;
      // Only admins can write
      allow write: if isAdmin();
    }
    
    // Config collection
    match /config/{configId} {
      // Everyone can read
      allow read: if true;
      // Only admins can write
      allow write: if isAdmin();
    }
    
    // Coming Soon collection
    match /comingSoon/{contentId} {
      // Everyone can read coming soon content
      allow read: if true;
      // Only admins can write
      allow write: if isAdmin();
    }
    
    // Player Configs collection
    match /playerConfigs/{contentId} {
      // Everyone can read player configs (needed for playback)
      allow read: if true;
      // Only admins can write
      allow write: if isAdmin();
    }

    // Live Shows collection
    match /liveShows/{showId} {
      // Everyone can read schedule
      allow read: if true;
      // Only admins can write
      allow write: if isAdmin();
    }

    // Live Stats collection
    match /liveStats/{userId} {
      allow read: if isAuthenticated() && request.auth.uid == userId;
      allow write: if isAdmin();
    }
    
    // View Events collection (analytics)
    match /viewEvents/{eventId} {
      // Authenticated users can create view events (for tracking)
      allow create: if isAuthenticated();
      // Only admins can read analytics
      allow read: if isAdmin();
      // No updates or deletes
      allow update, delete: if false;
    }
    
    // Content Analytics collection
    match /contentAnalytics/{contentId} {
      // Everyone can read (for displaying stats)
      allow read: if true;
      // System can write (via admin functions)
      allow write: if isAdmin();
    }
    
    // Content Ratings collection
    match /contentRatings/{contentId} {
      // Everyone can read ratings
      allow read: if true;
      // Authenticated users can create/update their own ratings
      allow create, update: if isAuthenticated();
      // Only admins can delete
      allow delete: if isAdmin();
    }
    
    // User Preferences collection (likes, favorites, watchlist)
    match /userPreferences/{userId} {
      // Users can read their own preferences
      allow read: if isAuthenticated() && request.auth.uid == userId;
      // Users can create/update their own preferences
      allow create, update: if isAuthenticated() && request.auth.uid == userId;
      // Only admins can delete
      allow delete: if isAdmin();
    }
    
    // Recommendations collection
    match /recommendations/{contentId} {
      // Everyone can read recommendations
      allow read: if true;
      // Only admins can write
      allow write: if isAdmin();
    }
    
    // Contact submissions (legacy)
    match /contactSubmissions/{submissionId} {
      allow read, write: if isAdmin();
    }

    // Contact messages (authenticated only)
    match /contactMessages/{messageId} {
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.userId;
      allow read, update, delete: if isAdmin();
    }

    // Admin audit logs
    match /adminAuditLogs/{logId} {
      allow read, write: if isAdmin();
    }

    // Session and rate limit tracking (server-only)
    match /sessions/{sessionId} {
      allow read, write: if false;
    }

    match /rateLimits/{rateLimitId} {
      allow read, write: if false;
    }
    
    // Pending uploads
    match /pendingUploads/{uploadId} {
      // Employees and admins can create
      allow create: if isEmployeeOrAdmin();
      // Employees and admins can read their own uploads, admins can read all
      allow read: if isEmployeeOrAdmin() && (resource.data.uploadedBy == request.auth.uid || isAdmin());
      // Only admins can update (approve/reject)
      allow update: if isAdmin();
      // Only admins can delete
      allow delete: if isAdmin();
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      // Authenticated users can create notifications (for sending)
      allow create: if isAuthenticated();
      // Only admins can read all notifications
      allow read: if isAdmin();
      // Only admins can update (for retrying, marking as sent, etc.)
      allow update: if isAdmin();
      // Only admins can delete
      allow delete: if isAdmin();
    }

    // Site Notifications collection (in-app notifications)
    match /siteNotifications/{notificationId} {
      allow create: if isAuthenticated() && isAdmin();
      // Users can read their own notifications
      allow read: if isAuthenticated() && request.auth.uid == resource.data.userId;
      // Users can list notifications (queries are filtered by userId in the code)
      allow list: if isAuthenticated();
      allow update: if isAuthenticated() && request.auth.uid == resource.data.userId;
      allow delete: if isAuthenticated() && (isAdmin() || request.auth.uid == resource.data.userId);
    }

    // User Activity collection
    match /userActivity/{userId} {
      allow create, update: if isAuthenticated() && request.auth.uid == userId;
      allow read: if isAdmin();
      allow delete: if isAdmin();
    }

    // Telemetry collection (error/warning logs)
    match /telemetry/{logId} {
      // System can create logs (via client-side code)
      allow create: if isAuthenticated();
      // Only admins can read telemetry
      allow read: if isAdmin();
      // Only admins can update (resolve logs)
      allow update: if isAdmin();
      // Only admins can delete
      allow delete: if isAdmin();
    }

    // CDN Uploads collection (tracking uploads to Cloudinary)
    match /cdnUploads/{uploadId} {
      // System can create upload logs
      allow create: if isAuthenticated();
      // Only admins can read CDN uploads
      allow read: if isAdmin();
      // Only admins can update/delete
      allow update, delete: if isAdmin();
    }

    // API Keys collection
    match /apiKeys/{keyId} {
      // Users can create their own API keys
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      // Users can read their own API keys
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Users can update their own API keys
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Users can delete their own API keys
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
      // Admins can read all API keys
      allow read: if isAdmin();
    }

    // API Usage collection (logging)
    match /apiUsage/{usageId} {
      // System can create usage logs (via API middleware)
      allow create: if true; // API middleware creates these
      // Only admins can read usage logs
      allow read: if isAdmin();
      // No updates or deletes
      allow update, delete: if false;
    }

    // Security Events collection
    match /securityEvents/{eventId} {
      // Security events are created by the system (via API routes)
      allow create: if true; // Publicly writable by API routes
      // Only admins can read security events
      allow read: if isAdmin();
      // No updates or deletes
      allow update, delete: if false;
    }

    // IP Blacklist collection
    match /ipBlacklist/{ipId} {
      // Only admins can manage IP blacklist
      allow read, write: if isAdmin();
    }

    // IP Whitelist collection
    match /ipWhitelist/{ipId} {
      // Only admins can manage IP whitelist
      allow read, write: if isAdmin();
    }

    // Content Purchases collection
    match /purchases/{purchaseId} {
      // Users can read their own purchases
      allow read: if isAuthenticated() && request.auth.uid == resource.data.userId;
      // Users can create purchases (payment processing)
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.userId;
      // Admins can read all purchases
      allow read: if isAdmin();
      // No updates or deletes (purchases are final)
      allow update, delete: if false;
    }

    // MMI Tokens collection
    match /mmiTokens/{userId} {
      // Users can read their own token balance
      allow read: if isAuthenticated() && request.auth.uid == userId;
      // System can create/update tokens (via server functions)
      allow write: if isAdmin();
    }

    // Token Transactions collection
    match /tokenTransactions/{transactionId} {
      // Users can read their own transactions
      allow read: if isAuthenticated() && request.auth.uid == resource.data.userId;
      // System can create transactions (via server functions)
      allow create: if isAuthenticated();
      // Admins can read all transactions
      allow read: if isAdmin();
      // No updates or deletes
      allow update, delete: if false;
    }

    // Trivia Challenges collection
    match /triviaChallenges/{challengeId} {
      // Anyone can read active challenges
      allow read: if resource.data.active == true || isAdmin();
      // Only admins can create, update, delete
      allow write: if isAdmin();
    }

    // Trivia Sessions collection
    match /triviaSessions/{sessionId} {
      // Users can read their own sessions
      allow read: if isAuthenticated() && request.auth.uid == resource.data.userId;
      // Users can create their own sessions
      allow create: if isAuthenticated() && request.auth.uid == request.resource.data.userId;
      // Users can update their own sessions
      allow update: if isAuthenticated() && request.auth.uid == resource.data.userId;
      // Admins can read all sessions
      allow read: if isAdmin();
      // No deletes
      allow delete: if false;
    }

    // Conversations collection (1:1 messaging)
    match /conversations/{conversationId} {
      // Users can read conversations they're part of
      allow read: if isAuthenticated() && request.auth.uid in resource.data.participants;
      // Only employees and admins can create conversations
      allow create: if isEmployeeOrAdmin() && request.auth.uid in request.resource.data.participants;
      // Users can update conversations they're part of
      allow update: if isAuthenticated() && request.auth.uid in resource.data.participants;
      // No deletes
      allow delete: if false;
    }

    // Messages collection
    match /messages/{messageId} {
      // Users can read messages from conversations they're part of
      // We need to check if the user is in the conversation
      allow read: if isAuthenticated() && 
        exists(/databases/$(database)/documents/conversations/$(resource.data.conversationId)) &&
        request.auth.uid in get(/databases/$(database)/documents/conversations/$(resource.data.conversationId)).data.participants;
      // Only employees and admins can send messages
      allow create: if isEmployeeOrAdmin() && 
        request.auth.uid == request.resource.data.senderId &&
        exists(/databases/$(database)/documents/conversations/$(request.resource.data.conversationId)) &&
        request.auth.uid in get(/databases/$(database)/documents/conversations/$(request.resource.data.conversationId)).data.participants;
      // Users can update their own messages
      allow update: if isAuthenticated() && request.auth.uid == resource.data.senderId;
      // No deletes
      allow delete: if false;
    }
  }
}
